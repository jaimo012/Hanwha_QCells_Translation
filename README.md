# 🌐 한화큐셀 번역 프로젝트

MES 기술 문서(Word, PowerPoint, Excel)를 영어로 자동 번역하는 도구입니다.  
Google Gemini AI를 활용하여 **문맥에 맞는 정확한 기술 번역**을 제공합니다.

## 📋 프로젝트 정보

- **버전**: 1.6.0
- **Python 버전**: 3.12+
- **생성일**: 2026-01-08
- **최종 수정**: 2026-02-08

## ✨ 주요 기능

| 파일 형식 | 기능 |
|-----------|------|
| **Word (.docx)** | 본문, 표, 텍스트 상자 번역 + 서식 완벽 보존 |
| **PowerPoint (.pptx)** | 슬라이드, 그룹, 표 내부 번역 + 서식 보존 |
| **Excel (.xlsx)** | 셀 텍스트 번역 + 수식 자동 보호 |

### 🎯 핵심 특징

- **📚 용어집(Glossary) 지원**: 정의된 용어를 일관되게 번역 (프롬프트 주입 방식)
- **Google Sheets 연동**: 대량 파일을 스프레드시트로 관리
- **Context 분석**: 문서의 맥락을 먼저 분석하여 일관된 번역 품질 유지
- **파일별 배치 처리**: Word(30), PPT(70), Excel(70) 문장씩 효율적으로 번역
- **자동 저장**: 10배치마다 중간 저장으로 데이터 보호
- **서식 보존**: 폰트, 크기, 색상, 정렬 등 원본 서식 완벽 유지
- **Slack 알림**: 완료/오류 발생 시 Slack으로 알림
- **오류 기록**: 오류 발생 시 시트에 상세 기록 후 다음 파일 처리
- **🔄 이어하기 기능**: 중단된 작업(진행중/오류)을 기존 파일로 이어서 번역
- **🔠 확장자 정규화**: 대문자 확장자(.PPTX 등)를 소문자로 자동 변환
- **✅ 검증(Verify) 단계**: 완료 파일을 다시 열어 잔여 한글을 검사/보완
- **📋 최종검수(Final Review)**: 파일 존재/오픈/번역완료 여부 일괄 검사

## 🚀 시작하기

### 1. 가상환경 생성 및 활성화

```powershell
# 가상환경 생성
py -m venv venv

# 가상환경 활성화 (Windows PowerShell)
.\venv\Scripts\Activate.ps1

# 가상환경 활성화 (Windows CMD)
.\venv\Scripts\activate.bat
```

### 2. 의존성 패키지 설치

```powershell
pip install -r requirements.txt
```

### 3. 서비스 계정 설정

1. 서비스 계정 JSON 파일을 프로젝트 루트에 `credentials.json`으로 복사합니다.
2. Google Sheets에서 서비스 계정 이메일(`test-943@life-coordinator.iam.gserviceaccount.com`)에 **편집자** 권한을 부여합니다.

### 4. 번역 실행

```powershell
python run.py
```

### 5. 검수(Verify) 실행

1차 번역이 완료된 파일들의 남은 한글을 추가 번역합니다.

```powershell
python run_verify.py
```

### 6. 최종검수(Final Review) 실행

완료된 파일들의 존재 여부, 오픈 상태, 번역 완료 여부를 일괄 검사합니다.

```powershell
python run_final_review.py
```

## 📁 프로젝트 구조

```
한화큐셀 번역 프로젝트/
├── src/                          # 소스 코드
│   ├── __init__.py               # 패키지 초기화
│   ├── main.py                   # 메인 실행 로직
│   ├── config.py                 # 설정값 관리
│   ├── prompts.py                # AI 프롬프트 템플릿
│   ├── utils.py                  # 공통 유틸리티 함수
│   ├── translator.py             # 번역 API 호출
│   ├── sheets_manager.py         # Google Sheets 연동
│   ├── glossary.py               # 용어집 관리
│   ├── slack_notifier.py         # Slack 알림
│   ├── converter.py              # .doc → .docx 변환
│   ├── verify.py                 # 검수 프로세스
│   ├── final_review.py           # 최종검수 프로세스 ⭐ NEW
│   └── handlers/                 # 파일 형식별 핸들러
│       ├── __init__.py
│       ├── docx_handler.py       # Word 처리
│       ├── pptx_handler.py       # PowerPoint 처리
│       └── xlsx_handler.py       # Excel 처리
│
├── data/                         # 데이터 폴더
│   ├── 용어정의.xlsx             # 📚 용어집 파일 ⭐ NEW
│   ├── origin_data_folder/       # 📥 원본 파일 (폴더 구조 유지)
│   └── completed_folder/         # 📤 번역 완료 파일 (동일 구조로 저장)
│
├── credentials.json              # 서비스 계정 키 (git 제외)
├── venv/                         # Python 가상환경 (git 제외)
├── .gitignore                    # Git 제외 파일 목록
├── requirements.txt              # Python 패키지 목록
├── run.py                        # 번역 실행 스크립트
├── run_verify.py                 # 검수 실행 스크립트
├── run_final_review.py           # 최종검수 실행 스크립트 ⭐ NEW
└── README.md                     # 프로젝트 설명서
```

## 📊 Google Sheets 컬럼 구조

| 컬럼 | 내용 | 설명 |
|------|------|------|
| A | 연번 | 파일 순번 |
| B | 상위경로 | 예: MC, MCS, MES |
| C | 세부경로 | 예: 10.분석단계 |
| D | 파일명 | 확장자 포함 |
| E | 파일용량 | - |
| F | 파일유형 | docx, pptx, xlsx |
| **G** | **진행상태** | 대기/진행중/완료/오류/1차 검수완료 |
| **H** | **시작일시** | 자동 기록 |
| **I** | **종료일시** | 자동 기록 |
| J | 분석대상 | - |
| K | 분석완료 | - |
| **L** | **오류** | 오류 발생 시 상세 기록 |
| M | 비고 | - |
| N | 인풋토큰 | - |
| O | 아웃풋토큰 | - |
| P | 총비용 | - |

### 작업 흐름

1. **맨 위에서부터 순서대로** "완료"가 아닌 첫 번째 행을 찾음 (시트 우선순위 반영)
2. B~D열로 파일 경로 구성: `origin_data_folder/{상위경로}/{세부경로}/{파일명}`
3. 확장자가 대문자인 경우 소문자로 정규화 (시트 파일명도 업데이트)
4. 상태에 따른 분기 처리:
   - **대기**: 파일 복사 후 새로 번역 시작
   - **진행중/오류**: 기존 `-en` 파일로 이어서 번역 (이어하기 모드)
5. 진행상태 → "진행중", 시작일시 기록
6. 번역 실행
7. 완료 시: 진행상태 → "완료", 종료일시 기록
8. 오류 시: 진행상태 → "오류", L열에 상세 기록
9. 다음 파일로 이동

### 검수 프로세스 (`run_verify.py`)

1차 번역이 완료된 파일들에서 **남아있는 한글을 추가 번역**합니다.

1. 진행상태가 "완료"인 모든 파일을 조회
2. `completed_folder`에서 `-en`이 붙은 번역된 파일을 열기
3. 기존 번역 프로세스 실행 (한글이 있는 부분만 번역)
4. 동일 경로, 동일 파일명으로 저장 (덮어쓰기)
5. 진행상태 → "1차 검수완료"로 변경

### 최종검수 프로세스 (`run_final_review.py`)

번역 작업이 끝난 파일들의 **존재 여부, 오픈 상태, 번역 완료 여부**를 일괄 검사합니다.

동일 스프레드시트의 **"최종검수" 시트**를 사용합니다.

| 컬럼 | 내용 | 설명 |
|------|------|------|
| A | 연번 | 파일 순번 |
| B | 상위경로 | 예: MC, MCS, MES |
| C | 세부경로 | 예: 30. 개발단계/10. 기능설계서 |
| D | 원본 파일명 | 확장자 포함 |
| **E** | **번역본 파일명** | 자동 기록 (" - en" 파일) |
| **F** | **원본 파일여부** | True/False |
| **G** | **번역본 파일여부** | True/False |
| **H** | **원본 오픈상태** | True/False |
| **I** | **번역본 오픈상태** | True/False |
| **J** | **번역완료여부** | True (한글 없음) / False (한글 잔존) |
| **K** | **최종검수일시** | yyyy-mm-dd HH:MM:SS |

**검수 흐름:**
1. `completed_folder`에서 원본 파일 존재 확인 → F열
2. 번역본(" - en") 파일 검색 (doc→docx, 대문자→소문자 변환 대응) → E, G열
3. 원본 파일 오픈 시도 → H열
4. 번역본 파일 오픈 시도 → I열
5. 번역본 내 한글 잔존 여부 확인 → J열 (한글 있으면 False)
6. 검수 일시 기록 → K열
7. 1~6을 모든 행에 대해 반복 (이미 K열이 있는 행은 건너뜀)

## 📚 용어집(Glossary) 사용법

프로젝트 전체에서 일관된 용어 번역을 위해 **용어집 기능**을 제공합니다.

### 용어집 파일 위치
```
data/용어정의.xlsx
```

### 파일 형식
| 1열 (한국어) | 2열 (영어) |
|-------------|-----------|
| 품질 관리 | Quality Control |
| 생산 라인 | Production Line |
| 작업 지시 | Work Order |

- **첫 번째 열**: 한국어 용어
- **두 번째 열**: 영어 번역
- 헤더 행 포함 가능 (자동 처리)

### 작동 방식
1. 프로그램 시작 시 `용어정의.xlsx` 파일을 자동 로드
2. 번역 프롬프트에 용어집을 주입 (최대 200개 용어)
3. AI가 **용어집에 정의된 용어를 우선 적용**하여 번역
4. 프로젝트 전체에서 일관된 용어 사용 보장

### 설정
`src/config.py`에서 최대 용어 수를 조정할 수 있습니다:
```python
GLOSSARY_MAX_TERMS = 200  # 프롬프트에 포함할 최대 용어 수
```

## ⚙️ 설정 변경

`src/config.py` 파일에서 다음 설정을 변경할 수 있습니다:

| 설정 | 기본값 | 설명 |
|------|--------|------|
| `API_KEY` | - | Gemini API 키 |
| `MODEL_NAME` | `gemini-2.5-flash` | 사용할 AI 모델 |
| `GOOGLE_SHEETS_URL` | - | 작업 관리 시트 URL |
| `GOOGLE_SHEETS_NAME` | `RAW` | 시트 이름 |
| `BATCH_SIZE_DOCX` | `30` | Word 배치 크기 (문단이 길어서 작게) |
| `BATCH_SIZE_PPTX` | `70` | PowerPoint 배치 크기 (짧은 텍스트) |
| `BATCH_SIZE_XLSX` | `70` | Excel 배치 크기 (셀 단위) |
| `API_DELAY_SECONDS` | `0.5` | API 호출 간 대기 시간 |
| `AUTO_SAVE_INTERVAL` | `10` | 자동 저장 주기 (배치 단위) |
| `GLOSSARY_MAX_TERMS` | `200` | 용어집 최대 용어 수 |
| `slack_webhooks` | - | Slack 웹훅 URL |

## ⚠️ 주의사항

- **Excel 처리**: xlwings는 Windows에서만 동작합니다 (Microsoft Excel 필요)
- **API 제한**: Gemini API의 Rate Limit에 주의하세요
- **대용량 파일**: 큰 파일은 처리 시간이 오래 걸릴 수 있습니다
- **Google Sheets 권한**: 서비스 계정에 시트 편집 권한이 필요합니다

## 🔧 문제 해결

### Google Sheets 연결 실패
```
❌ Google Sheets 연결 실패
```
→ `credentials.json` 파일이 있는지, 서비스 계정에 시트 권한이 있는지 확인하세요.

### 파일을 찾을 수 없음
```
❌ 원본 파일을 찾을 수 없습니다
```
→ 시트의 경로(B~D열)가 `data/origin_data_folder` 내 실제 경로와 일치하는지 확인하세요.

### Excel 처리 실패
```
❌ Excel Error: ...
```
→ Microsoft Excel이 설치되어 있는지, 다른 프로그램에서 파일을 열고 있지 않은지 확인하세요.

### 파일 저장 실패 (Permission denied)
```
❌ 파일 저장 실패: Permission denied
```
→ 프로그램이 자동으로 최대 5번 재시도하며, 2번째 재시도부터 Word 프로세스를 강제 종료합니다.
→ 문제가 지속되면 작업 관리자에서 WINWORD.EXE 프로세스를 수동으로 종료하세요.

### 지원하지 않는 파일 형식
```
⚠️ 지원하지 않는 파일 형식: .PPTX
```
→ v1.4.0부터 대문자 확장자(.PPTX, .DOCX, .XLSX)도 자동 지원됩니다.

## 📝 버전 히스토리

### v1.6.0 (2026-02-08)
- 📋 **최종검수(Final Review) 프로세스 추가**
  - 완료 파일의 존재/오픈/번역완료 여부 일괄 검사
  - Google Sheets '최종검수' 시트 연동
  - 원본·번역본 파일 존재 확인, 오픈 상태 확인, 한글 잔존 검사
  - 번역본 파일명 자동 탐색 (doc→docx, 대문자→소문자 확장자 대응)
  - 행별 결과를 E~K열에 단일 API 호출로 효율 업데이트
  - 이미 검수된 행(K열 값 있음) 자동 건너뛰기
- `src/final_review.py` 모듈 추가
- `run_final_review.py` 실행 스크립트 추가

### v1.5.0 (2026-01-29)
- 🔍 **검수(Verify) 프로세스 추가**
  - 1차 번역 완료된 파일들의 남은 한글 추가 번역
  - `run_verify.py` 실행 스크립트 추가
  - 진행상태 "1차 검수완료" 상태 추가
  - 검수 완료 시 Slack 알림 발송
- `src/verify.py` 모듈 추가
- `sheets_manager.py`에 `get_completed_tasks()` 메서드 활용

### v1.4.0 (2026-01-09)
- 🔄 **이어하기(Resume) 기능 추가**
  - 진행중/오류 상태에서 기존 `-en` 파일로 이어서 번역
  - 토큰 사용량 누적 유지
- 📊 **파일별 배치 사이즈 분리**
  - Word: 30개 (문단이 길어서 작게)
  - PowerPoint: 70개 (짧은 텍스트가 많아서 크게)
  - Excel: 70개 (셀 단위라 크게)
- 🔠 **대문자 확장자 지원**
  - `.PPTX`, `.DOCX`, `.XLSX` 같은 대문자 확장자 자동 인식
  - 소문자로 정규화하여 저장 (시트 파일명도 자동 업데이트)
- 📋 **작업 순서 개선**
  - 맨 위에서부터 순차적으로 처리 (시트에 정렬된 우선순위 반영)
- 🔧 **안정성 개선**
  - 파일 저장 실패 시 자동 재시도 (최대 5회)
  - Word 프로세스 충돌 시 자동 강제 종료
  - `.doc` 변환 시 COM 객체 정리 개선
  - `None` 텍스트 안전하게 건너뛰기

### v1.3.0 (2026-01-08)
- 📚 **용어집(Glossary) 기능 추가**
  - `data/용어정의.xlsx` 파일 지원
  - 프롬프트 주입 방식으로 일관된 용어 번역 보장
  - 최대 200개 용어 자동 적용
- `src/glossary.py` 모듈 추가

### v1.2.0 (2026-01-08)
- Slack 알림 기능 추가 (완료/오류 시 웹훅 메시지)
- `.doc` → `.docx` 자동 변환 지원
- Google Sheets 실시간 진행 상황 업데이트 (J~O열)

### v1.1.0 (2026-01-08)
- Google Sheets 연동 기능 추가
- 대량 파일 처리 워크플로우 구현
- 오류 기록 및 자동 복구 기능
- 폴더 구조 변경 (data 폴더 하위로 이동)

### v1.0.0 (2026-01-08)
- 정식 버전 출시
- Word, PowerPoint, Excel 번역 지원
- 서식 보존 기능 구현
- 자동 저장 기능 추가

---

Made with ❤️ for 한화큐셀
